#!/bin/sh /etc/rc.common

START=99
STOP=10
USE_PROCD=1

PROG=/usr/bin/fan_control.sh
CONFIG=fan_control

start_service() {
	local enabled

	config_load "$CONFIG"
	config_get_bool enabled fan_control enabled 0

	if [ "$enabled" -eq 0 ]; then
		logger -t fan_control -p daemon.info "Fan control is disabled in config, not starting"
		return 0
	fi

	# 检查脚本是否存在且可执行
	if [ ! -x "$PROG" ]; then
		logger -t fan_control -p daemon.err "Control script not found or not executable: $PROG"
		return 1
	fi

	# 检查 hwmon 子系统（非阻塞，脚本内部会等待）
	if [ ! -d "/sys/class/hwmon" ]; then
		logger -t fan_control -p daemon.warning "/sys/class/hwmon not available yet, service will wait for it"
	fi

	logger -t fan_control -p daemon.info "Starting fan control service"

	procd_open_instance
	procd_set_param command "$PROG"
	procd_set_param respawn 3600 5 5
	procd_set_param stdout 1
	procd_set_param stderr 1
	procd_close_instance
}

stop_service() {
	logger -t fan_control -p daemon.info "Stopping fan control service"
}

reload_service() {
	logger -t fan_control -p daemon.info "Reloading fan control service"
	stop
	start
}

service_triggers() {
	procd_add_reload_trigger "$CONFIG"
}
