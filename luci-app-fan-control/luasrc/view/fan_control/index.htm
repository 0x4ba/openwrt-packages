<%+header%>

<style>
.fan-control-section {
    margin-bottom: 20px;
    padding: 15px;
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.fan-control-section h3 {
    margin-top: 0;
    border-bottom: 2px solid #0099cc;
    padding-bottom: 10px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
}

.form-group select,
.form-group input {
    width: 100%;
    max-width: 400px;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 3px;
}

.mapping-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.mapping-table th,
.mapping-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: left;
}

.mapping-table th {
    background: #0099cc;
    color: white;
}

.mapping-table tr:nth-child(even) {
    background: #f2f2f2;
}

.add-mapping {
    margin-top: 15px;
    padding: 15px;
    background: #e8f4f8;
    border: 1px dashed #0099cc;
    border-radius: 5px;
}

.add-mapping input {
    width: 120px;
    padding: 8px;
    margin-right: 10px;
    border: 1px solid #ccc;
    border-radius: 3px;
}

.btn {
    padding: 8px 15px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-weight: bold;
}

.btn-primary {
    background: #0099cc;
    color: white;
}

.btn-primary:hover {
    background: #007aa3;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.btn-success {
    background: #28a745;
    color: white;
    margin-left: 10px;
}

.btn-success:hover {
    background: #218838;
}

.status-info {
    padding: 10px;
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    border-radius: 3px;
    margin-bottom: 15px;
}

.description {
    color: #666;
    font-size: 0.9em;
    margin-top: 5px;
}

.switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #0099cc;
}

input:checked + .slider:before {
    transform: translateX(26px);
}
</style>

<h2><%:Fan Control%></h2>
<p><%:Control fan speed based on CPU temperature. When temperature reaches or exceeds a threshold, the corresponding fan speed will be applied.%></p>

<div class="status-info" id="status-info" style="display:none;">
    <strong><%:Status:%></strong>
    <span id="status-text"></span>
</div>

<div class="fan-control-section">
    <h3><%:Control Settings%></h3>

    <div class="form-group">
        <label for="enabled"><%:Enable Fan Control%></label>
        <label class="switch">
            <input type="checkbox" id="enabled">
            <span class="slider"></span>
        </label>
        <div class="description"><%:Enable or disable automatic fan speed control based on temperature%></div>
    </div>

    <div class="form-group">
        <label for="sensor"><%:Temperature Sensor%></label>
        <select id="sensor">
            <option value=""><%:-- Please select --%></option>
        </select>
        <div class="description"><%:Select the temperature sensor to monitor%></div>
    </div>

    <div class="form-group">
        <label for="fan"><%:PWM Fan Control%></label>
        <select id="fan">
            <option value=""><%:-- Please select --%></option>
        </select>
        <div class="description"><%:Select the PWM fan device to control%></div>
    </div>

    <button class="btn btn-primary" onclick="saveConfig()"><%:Save & Apply%></button>
</div>

<div class="fan-control-section">
    <h3><%:Temperature to Fan Speed Mapping%></h3>
    <p class="description"><%:Define temperature thresholds and corresponding fan speeds. When temperature >= threshold, the fan speed will be set accordingly.%></p>

    <table class="mapping-table" id="mapping-table">
        <thead>
            <tr>
                <th><%:Temperature (Â°C)%></th>
                <th><%:Fan Speed (PWM 0-255)%></th>
                <th><%:Action%></th>
            </tr>
        </thead>
        <tbody id="mapping-tbody">
        </tbody>
    </table>

    <div class="add-mapping">
        <strong><%:Add New Mapping%></strong>
        <div style="margin-top: 10px;">
            <input type="number" id="new-temp" placeholder="<%:Temperature%>" min="0" max="150">
            <input type="number" id="new-speed" placeholder="<%:Fan Speed%>" min="0" max="255">
            <button class="btn btn-success" onclick="addMapping()"><%:Add%></button>
        </div>
    </div>
</div>

<script type="text/javascript">
function loadHwmonDevices() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '<%=url('admin/services/fan_control/get_devices')%>', true);
    xhr.onload = function() {
        if (xhr.status === 200) {
            try {
                var data = JSON.parse(xhr.responseText);

                var sensorSelect = document.getElementById('sensor');
                var fanSelect = document.getElementById('fan');

                sensorSelect.innerHTML = '<option value=""><%:-- Please select --%></option>';
                fanSelect.innerHTML = '<option value=""><%:-- Please select --%></option>';

                for (var path in data.sensors) {
                    var option = document.createElement('option');
                    option.value = path;
                    option.textContent = data.sensors[path];
                    sensorSelect.appendChild(option);
                }

                for (var path in data.fans) {
                    var option = document.createElement('option');
                    option.value = path;
                    option.textContent = data.fans[path];
                    fanSelect.appendChild(option);
                }
            } catch (e) {
                console.error('Failed to load devices:', e);
                showStatus('<%:Failed to load devices%>', 'error');
            }
        } else {
            console.error('HTTP error:', xhr.status);
            showStatus('<%:Failed to load devices%> (HTTP ' + xhr.status + ')', 'error');
        }
    };
    xhr.onerror = function() {
        console.error('Network error loading devices');
        showStatus('<%:Network error loading devices%>', 'error');
    };
    xhr.send();
}

function loadConfig() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '<%=url('admin/services/fan_control/get_config')%>', true);
    xhr.onload = function() {
        if (xhr.status === 200) {
            try {
                var data = JSON.parse(xhr.responseText);
                document.getElementById('enabled').checked = data.enabled === '1';
                document.getElementById('sensor').value = data.sensor || '';
                document.getElementById('fan').value = data.fan || '';
            } catch (e) {
                console.error('Failed to load config:', e);
            }
        }
    };
    xhr.onerror = function() {
        console.error('Network error loading config');
    };
    xhr.send();
}

function loadMappings() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '<%=url('admin/services/fan_control/list_map')%>', true);
    xhr.onload = function() {
        if (xhr.status === 200) {
            try {
                var data = JSON.parse(xhr.responseText);
                var tbody = document.getElementById('mapping-tbody');
                tbody.innerHTML = '';

                data.maps.forEach(function(map) {
                    var row = tbody.insertRow();
                    row.insertCell(0).textContent = map.temperature;
                    row.insertCell(1).textContent = map.speed;
                    var actionCell = row.insertCell(2);
                    var deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger';
                    deleteBtn.textContent = '<%:Delete%>';
                    deleteBtn.onclick = function() { deleteMapping(map.idx); };
                    actionCell.appendChild(deleteBtn);
                });
            } catch (e) {
                console.error('Failed to load mappings:', e);
            }
        }
    };
    xhr.onerror = function() {
        console.error('Network error loading mappings');
    };
    xhr.send();
}

function saveConfig() {
    var enabled = document.getElementById('enabled').checked ? '1' : '0';
    var sensor = document.getElementById('sensor').value;
    var fan = document.getElementById('fan').value;

    var params = 'enabled=' + enabled + '&sensor=' + encodeURIComponent(sensor) + '&fan=' + encodeURIComponent(fan);

    var xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=url('admin/services/fan_control/save_config')%>', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function() {
        if (xhr.status === 200) {
            showStatus('<%:Configuration saved successfully!%>', 'success');
        } else {
            showStatus('<%:Failed to save configuration%>', 'error');
        }
    };
    xhr.onerror = function() {
        showStatus('<%:Network error saving configuration%>', 'error');
    };
    xhr.send(params);
}

function addMapping() {
    var temp = document.getElementById('new-temp').value;
    var speed = document.getElementById('new-speed').value;

    if (!temp || !speed) {
        alert('<%:Please fill in both temperature and fan speed%>');
        return;
    }

    if (temp < 0 || temp > 150) {
        alert('<%:Temperature must be between 0 and 150%>');
        return;
    }

    if (speed < 0 || speed > 255) {
        alert('<%:Fan speed must be between 0 and 255%>');
        return;
    }

    var params = 'temperature=' + temp + '&speed=' + speed;

    var xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=url('admin/services/fan_control/add_map')%>', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function() {
        if (xhr.status === 200) {
            try {
                var data = JSON.parse(xhr.responseText);
                if (data.success) {
                    document.getElementById('new-temp').value = '';
                    document.getElementById('new-speed').value = '';
                    loadMappings();
                    showStatus('<%:Mapping added successfully!%>', 'success');
                } else {
                    showStatus('<%:Failed to add mapping:%> ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (e) {
                showStatus('<%:Failed to add mapping%>', 'error');
            }
        } else {
            showStatus('<%:Failed to add mapping%>', 'error');
        }
    };
    xhr.onerror = function() {
        showStatus('<%:Network error adding mapping%>', 'error');
    };
    xhr.send(params);
}

function deleteMapping(idx) {
    if (!confirm('<%:Are you sure you want to delete this mapping?%>')) {
        return;
    }

    var xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=url('admin/services/fan_control/delete_map')%>', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function() {
        if (xhr.status === 200) {
            loadMappings();
            showStatus('<%:Mapping deleted successfully!%>', 'success');
        } else {
            showStatus('<%:Failed to delete mapping%>', 'error');
        }
    };
    xhr.onerror = function() {
        showStatus('<%:Network error deleting mapping%>', 'error');
    };
    xhr.send('idx=' + encodeURIComponent(idx));
}

function showStatus(message, type) {
    var statusInfo = document.getElementById('status-info');
    var statusText = document.getElementById('status-text');
    statusText.textContent = message;
    statusInfo.style.display = 'block';
    statusInfo.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
    statusInfo.style.borderColor = type === 'success' ? '#c3e6cb' : '#f5c6cb';

    setTimeout(function() {
        statusInfo.style.display = 'none';
    }, 3000);
}

window.onload = function() {
    loadHwmonDevices();
    loadConfig();
    loadMappings();
};
</script>

<%+footer%>
