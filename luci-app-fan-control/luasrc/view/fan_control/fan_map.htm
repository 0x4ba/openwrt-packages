<%+header%>

<style>
.fan-map-container {
    margin: 20px 0;
}

.fan-map-add-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 4px;
    border: 1px solid #e0e0e0;
}

.fan-map-add-bar input {
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    flex: 1;
    max-width: 150px;
}

.fan-map-add-bar button {
    padding: 8px 20px;
    background-color: #0069d6;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
}

.fan-map-add-bar button:hover {
    background-color: #0056b3;
}

.fan-map-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

.fan-map-table thead {
    background-color: #f5f5f5;
}

.fan-map-table th {
    padding: 12px;
    text-align: left;
    border-bottom: 2px solid #ddd;
    font-weight: 600;
}

.fan-map-table td {
    padding: 10px 12px;
    border-bottom: 1px solid #e0e0e0;
}

.fan-map-table tr:hover {
    background-color: #f9f9f9;
}

.fan-map-delete-btn {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
}

.fan-map-delete-btn:hover {
    background-color: #c82333;
}

.error-msg {
    color: #dc3545;
    padding: 10px;
    margin: 10px 0;
    border: 1px solid #f5c6cb;
    border-radius: 4px;
    background-color: #f8d7da;
    display: none;
}

.success-msg {
    color: #155724;
    padding: 10px;
    margin: 10px 0;
    border: 1px solid #c3e6cb;
    border-radius: 4px;
    background-color: #d4edda;
    display: none;
}
</style>

<h2>Temperature to Fan Speed Mapping</h2>

<div class="fan-map-container">
    <div id="error-msg" class="error-msg"></div>
    <div id="success-msg" class="success-msg"></div>
    
    <div class="fan-map-add-bar">
        <input type="number" id="temp-input" placeholder="Temperature (°C)" min="0" max="120" />
        <input type="number" id="speed-input" placeholder="Fan Speed (0-255)" min="0" max="255" />
        <button onclick="addMapEntry()">Add</button>
    </div>
    
    <table class="fan-map-table">
        <thead>
            <tr>
                <th>Temperature (°C)</th>
                <th>Fan Speed (0-255)</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="map-table-body">
        </tbody>
    </table>
</div>

<script>
function showMessage(msg, type) {
    const container = type === 'error' ? document.getElementById('error-msg') : document.getElementById('success-msg');
    container.textContent = msg;
    container.style.display = 'block';
    setTimeout(() => {
        container.style.display = 'none';
    }, 3000);
}

function loadMapEntries() {
    const xhr = new XMLHttpRequest();
    xhr.open('GET', window.location.href, true);
    xhr.onload = function() {
        if (xhr.status === 200) {
            const tbody = document.getElementById('map-table-body');
            tbody.innerHTML = '';
            
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.maps) {
                    response.maps.sort((a, b) => parseInt(a.temperature) - parseInt(b.temperature));
                    response.maps.forEach(entry => {
                        const row = document.createElement('tr');
                        row.innerHTML = '<td>' + entry.temperature + '</td><td>' + entry.speed + '</td><td><button class="fan-map-delete-btn" onclick="deleteMapEntry(' + entry.idx + ')">Delete</button></td>';
                        tbody.appendChild(row);
                    });
                }
            } catch (e) {
                console.error('Error parsing response:', e);
            }
        }
    };
    xhr.send();
}

function addMapEntry() {
    const temp = document.getElementById('temp-input').value;
    const speed = document.getElementById('speed-input').value;
    
    if (!temp || !speed) {
        showMessage('Please fill in all fields', 'error');
        return;
    }
    
    const tempNum = parseInt(temp);
    const speedNum = parseInt(speed);
    
    if (tempNum < 0 || tempNum > 120 || speedNum < 0 || speedNum > 255) {
        showMessage('Invalid values', 'error');
        return;
    }
    
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=luci.dispatcher.build_url("admin/services/fan_control/add_map")%>', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function() {
        if (xhr.status === 200) {
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    document.getElementById('temp-input').value = '';
                    document.getElementById('speed-input').value = '';
                    showMessage('Entry added successfully', 'success');
                    setTimeout(loadMapEntries, 500);
                } else {
                    showMessage('Failed to add entry: ' + response.error, 'error');
                }
            } catch (e) {
                showMessage('Error adding entry', 'error');
            }
        }
    };
    xhr.send('temperature=' + tempNum + '&speed=' + speedNum);
}

function deleteMapEntry(idx) {
    if (confirm('Are you sure?')) {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '<%=luci.dispatcher.build_url("admin/services/fan_control/delete_map")%>', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.onload = function() {
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    showMessage('Entry deleted successfully', 'success');
                    setTimeout(loadMapEntries, 500);
                } else {
                    showMessage('Failed to delete entry', 'error');
                }
            } catch (e) {
                showMessage('Error deleting entry', 'error');
            }
        };
        xhr.send('idx=' + idx);
    }
}

window.onload = function() {
    loadMapEntries();
};

setInterval(loadMapEntries, 2000);
</script>

<%+footer%>

